version: '3.8'

services:
  # Worker Service
  worker:
    build:
      context: ../../../..  # Build from parent directory to include SDK dependencies
      dockerfile: codex/automations/your-worker/Dockerfile.worker
    container_name: your-worker-name
    env_file:
      - .env  # Load environment variables from .env file
    environment:
      # Required environment variables for the worker (these override .env if set)
      - SERVER_NAME=${SERVER_NAME:-your-worker-name}
      - GRPC_SERVER_ADDRESS=${GRPC_SERVER_ADDRESS:-0.0.0.0:50051}
      - SERVER_API_TOKEN=${SERVER_API_TOKEN}
      
      # Database configuration (if needed)
      # - DB_HOST=${DB_HOST}
      # - DB_PORT=${DB_PORT:-5432}
      # - DB_USER=${DB_USER}
      # - DB_PASSWORD=${DB_PASSWORD}
      # - DB_NAME=${DB_NAME}
      
      # OpenAI configuration (if needed)
      # - OPENAI_API_KEY=${OPENAI_API_KEY}
      
      # Other configuration
      - CODEX_DEBUG=${CODEX_DEBUG:-false}
      
      # CRITICAL: Go runtime configuration - trigger aggressive GC before hitting Docker limit
      - GOMEMLIMIT=450MiB
    restart: on-failure:1  # Retry once only - fail fast to prevent system overload
    # CRITICAL SAFETY: Resource limits to prevent memory leaks from affecting other services
    # Must use 'docker compose --compatibility up' to enforce these limits!
    deploy:
      resources:
        limits:
          memory: 512M  # Hard limit - conservative for multi-service environment
          cpus: '1.0'
        reservations:
          memory: 256M  # Guaranteed minimum
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "pgrep", "worker"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - worker-network

  # Example: Batch Job Service (optional, runs with --profile job)
  # job:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.job
  #   container_name: your-worker-job
  #   env_file:
  #     - .env
  #   environment:
  #     - DB_HOST=${DB_HOST}
  #     - DB_PORT=${DB_PORT:-5432}
  #     - DB_USER=${DB_USER}
  #     - DB_PASSWORD=${DB_PASSWORD}
  #     - DB_NAME=${DB_NAME}
  #     - CODEX_DEBUG=${CODEX_DEBUG:-true}
  #   volumes:
  #     - cache-data:/app/data
  #   profiles:
  #     - job  # Only run when explicitly requested with --profile job
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 2G
  #         cpus: '1.5'
  #       reservations:
  #         memory: 1G
  #         cpus: '0.5'
  #   networks:
  #     - worker-network

networks:
  worker-network:
    driver: bridge

# Uncomment if you need persistent volumes
# volumes:
#   cache-data:
#     driver: local

# Example usage:
# 1. Start only the worker service:
#    docker compose up worker
#
# 2. Build with no cache:
#    docker compose build --no-cache worker
#
# 3. Run with enforced resource limits (CRITICAL for memory leak protection):
#    docker compose --compatibility up worker -d
#
# 4. Run a batch job (if configured):
#    docker compose --profile job up job
#
# 5. View logs:
#    docker compose logs worker -f
#
# 6. Stop and clean up:
#    docker compose down

